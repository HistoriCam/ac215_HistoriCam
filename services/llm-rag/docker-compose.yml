networks:
    default:
        name: llm-rag-network
        external: true
services:
    llm-rag-cli:
        image: llm-rag-cli
        container_name: llm-rag-cli
        ports:
            # Use a different host port to avoid colliding with the ChromaDB service (host:8000)
            - "8001:8001"
        volumes:
            - ../../secrets:/secrets
            - ../llm-rag:/app
        environment:
            - GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcs-service-account.json
            - GCP_PROJECT=ac215-historicam
        depends_on:
            - chromadb
        # Start the FastAPI server automatically so the container remains running
        command: ["/bin/bash", "-c", "/.venv/bin/uvicorn server:app --host 0.0.0.0 --port 8001"]
        restart: unless-stopped
    chromadb:
        image: chromadb/chroma:latest
        container_name: llm-rag-chromadb
        ports:
            - 8002:8000
        volumes:
            - ./docker-volumes/chromadb:/chroma/chroma
        environment:
            - IS_PERSISTENT=TRUE
            - ANONYMIZED_TELEMETRY=FALSE
            - CHROMA_CORS_ALLOW_ORIGINS=["*"]
