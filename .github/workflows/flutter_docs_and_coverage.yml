name: Generate Flutter AutoDocs & Test Coverage Report

on:
  push:
    branches:
      - main
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/flutter_docs_and_coverage.yml'
  pull_request:
    branches:
      - main
    types:
      - closed
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/flutter_docs_and_coverage.yml'
  workflow_dispatch:

jobs:
  docs-and-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate documentation
        run: |
          # Generate dartdoc documentation
          dart doc --output ../../docs/app

          # Create index redirect if it doesn't exist
          if [ ! -f ../../docs/app/index.html ]; then
            mkdir -p ../../docs/app
            cat > ../../docs/app/index.html << 'EOFHTML'
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=historicam/historicam-library.html">
            <title>HistoriCam Documentation</title>
          </head>
          <body>
            <p>Redirecting to <a href="historicam/historicam-library.html">HistoriCam documentation</a>...</p>
          </body>
          </html>
          EOFHTML
          fi

      - name: Run tests with coverage
        run: flutter test --coverage --no-pub
        continue-on-error: true

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Filter coverage data
        run: |
          if [ -f coverage/lcov.info ]; then
            # Remove generated files and test files from coverage
            lcov --remove coverage/lcov.info \
              '**/*.g.dart' \
              '**/*.freezed.dart' \
              '**/test/**' \
              '**/tests/**' \
              -o coverage/lcov_filtered.info

            # Replace original with filtered
            mv coverage/lcov_filtered.info coverage/lcov.info
          fi

      - name: Generate coverage summary
        id: coverage
        run: |
          # Generate coverage summary
          lcov --summary coverage/lcov.info > coverage_summary.txt 2>&1 || echo "No coverage data available"

          # Extract coverage percentage
          if [ -f coverage/lcov.info ]; then
            LINES_PERCENT=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+(?=%)')
            FUNCTIONS_PERCENT=$(lcov --summary coverage/lcov.info 2>&1 | grep "functions" | grep -oP '\d+\.\d+(?=%)' || echo "N/A")

            # If grep fails, set default
            if [ -z "$LINES_PERCENT" ]; then
              LINES_PERCENT="0.0"
            fi
            if [ -z "$FUNCTIONS_PERCENT" ]; then
              FUNCTIONS_PERCENT="N/A"
            fi

            # Get total lines and covered lines for detailed reporting
            TOTAL_LINES=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | grep -oP '\d+(?= of)')
            COVERED_LINES=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | grep -oP '(?<=of )\d+')

            echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
            echo "covered_lines=$COVERED_LINES" >> $GITHUB_OUTPUT
          else
            LINES_PERCENT="0.0"
            FUNCTIONS_PERCENT="N/A"
            echo "total_lines=0" >> $GITHUB_OUTPUT
            echo "covered_lines=0" >> $GITHUB_OUTPUT
          fi

          echo "lines_percent=$LINES_PERCENT" >> $GITHUB_OUTPUT
          echo "functions_percent=$FUNCTIONS_PERCENT" >> $GITHUB_OUTPUT

          # Get test count
          TEST_COUNT=$(find test -name "*_test.dart" | wc -l)
          echo "test_count=$TEST_COUNT" >> $GITHUB_OUTPUT

          # Count total Dart files in lib (excluding generated files)
          TOTAL_FILES=$(find lib -name "*.dart" ! -name "*.g.dart" ! -name "*.freezed.dart" | wc -l)
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT

      - name: Check coverage threshold
        run: |
          LINES_PERCENT="${{ steps.coverage.outputs.lines_percent }}"
          THRESHOLD=70.0

          echo "Current coverage: ${LINES_PERCENT}%"
          echo "Required threshold: ${THRESHOLD}%"

          # Compare using bc for decimal comparison
          if command -v bc &> /dev/null; then
            RESULT=$(echo "${LINES_PERCENT} >= ${THRESHOLD}" | bc)
            if [ "$RESULT" -eq 0 ]; then
              echo "::warning::Coverage ${LINES_PERCENT}% is below threshold ${THRESHOLD}%"
              echo "Coverage is below the required threshold!"
              # Uncomment the next line to fail the build if coverage is below threshold
              # exit 1
            else
              echo "::notice::Coverage ${LINES_PERCENT}% meets threshold ${THRESHOLD}%"
              echo "Coverage meets the required threshold!"
            fi
          else
            # Fallback to integer comparison if bc is not available
            LINES_INT=${LINES_PERCENT%.*}
            THRESHOLD_INT=${THRESHOLD%.*}
            if [ "$LINES_INT" -lt "$THRESHOLD_INT" ]; then
              echo "::warning::Coverage ~${LINES_INT}% is below threshold ~${THRESHOLD_INT}%"
              echo "Coverage is below the required threshold!"
              # Uncomment the next line to fail the build if coverage is below threshold
              # exit 1
            else
              echo "::notice::Coverage ~${LINES_INT}% meets threshold ~${THRESHOLD_INT}%"
              echo "Coverage meets the required threshold!"
            fi
          fi

      - name: Generate coverage markdown report
        run: |
          mkdir -p ../../docs/tests

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          BRANCH="${{ github.ref_name }}"
          LINES_PERCENT="${{ steps.coverage.outputs.lines_percent }}"
          FUNCTIONS_PERCENT="${{ steps.coverage.outputs.functions_percent }}"
          TEST_COUNT="${{ steps.coverage.outputs.test_count }}"
          TOTAL_FILES="${{ steps.coverage.outputs.total_files }}"
          COVERED_LINES="${{ steps.coverage.outputs.covered_lines }}"
          TOTAL_LINES="${{ steps.coverage.outputs.total_lines }}"

          cat > ../../docs/tests/coverage-report.md << EOFMD
          # Test Coverage Report

          ## Flutter Mobile App Coverage

          ### Overall Coverage

          | Metric | Coverage | Details |
          |--------|----------|---------|
          | **Lines** | **${LINES_PERCENT}%** | ${COVERED_LINES} of ${TOTAL_LINES} lines |
          | **Functions** | **${FUNCTIONS_PERCENT}%** | - |

          ### Test Statistics

          - **Total Test Files**: ${TEST_COUNT}
          - **Total Source Files**: ${TOTAL_FILES} (excluding generated files)
          - **Last Updated**: ${TIMESTAMP}
          - **Commit**: [${COMMIT_SHORT}](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})
          - **Branch**: ${BRANCH}

          ### Coverage Status

          EOFMD

          # Add status badge based on coverage
          LINES_INT=${LINES_PERCENT%.*}

          if [ "$LINES_INT" -ge 80 ]; then
            echo "![Coverage Status](https://img.shields.io/badge/coverage-${LINES_PERCENT}%25-brightgreen)" >> ../../docs/tests/coverage-report.md
            echo "" >> ../../docs/tests/coverage-report.md
            echo "✅ **Excellent coverage!** The codebase has great test coverage." >> ../../docs/tests/coverage-report.md
          elif [ "$LINES_INT" -ge 70 ]; then
            echo "![Coverage Status](https://img.shields.io/badge/coverage-${LINES_PERCENT}%25-green)" >> ../../docs/tests/coverage-report.md
            echo "" >> ../../docs/tests/coverage-report.md
            echo "✅ **Good coverage!** Meets the 70% threshold." >> ../../docs/tests/coverage-report.md
          elif [ "$LINES_INT" -ge 60 ]; then
            echo "![Coverage Status](https://img.shields.io/badge/coverage-${LINES_PERCENT}%25-yellow)" >> ../../docs/tests/coverage-report.md
            echo "" >> ../../docs/tests/coverage-report.md
            echo "⚠️ **Coverage below threshold.** Target is 70%, current is ${LINES_PERCENT}%." >> ../../docs/tests/coverage-report.md
          else
            echo "![Coverage Status](https://img.shields.io/badge/coverage-${LINES_PERCENT}%25-red)" >> ../../docs/tests/coverage-report.md
            echo "" >> ../../docs/tests/coverage-report.md
            echo "❌ **Low coverage!** Please add more tests. Target is 70%, current is ${LINES_PERCENT}%." >> ../../docs/tests/coverage-report.md
          fi

          cat >> ../../docs/tests/coverage-report.md << 'EOFMD'

          ### Coverage Guidelines

          - **Excellent**: ≥ 80% - Great job! Keep it up.
          - **Good**: 70-79% - Meets threshold requirement.
          - **Below Threshold**: 60-69% - Consider adding more tests.
          - **Needs Improvement**: < 60% - Please prioritize test coverage.

          ### Coverage Threshold

          This project requires a **minimum of 70% line coverage**. The workflow will warn if coverage falls below this threshold.

          ### How to Run Tests Locally

          ```bash
          cd apps/mobile
          flutter test --coverage
          ```

          ### View Detailed Coverage

          To view detailed line-by-line coverage:

          ```bash
          # Generate HTML report
          genhtml coverage/lcov.info -o coverage/html

          # Open in browser (macOS)
          open coverage/html/index.html

          # Open in browser (Linux)
          xdg-open coverage/html/index.html

          # Open in browser (Windows)
          start coverage/html/index.html
          ```

          ### Excluded from Coverage

          The following are excluded from coverage calculations:
          - Generated files (`*.g.dart`, `*.freezed.dart`)
          - Test files
          - Third-party packages

          ---

          *This report is automatically generated by the Flutter Docs & Coverage workflow.*
          EOFMD

      - name: Commit documentation and coverage
        # Run for push, workflow_dispatch, and merged PRs to main
        if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Move to repo root
          cd ../..

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          echo "Files to be added:"
          ls -R docs/app docs/tests || true

          # Add both documentation and coverage report
          git add docs/app docs/tests

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No documentation or coverage changes to commit"
            git status
            exit 0
          fi

          echo "Committing documentation and coverage changes..."
          git status --short

          # Single commit for both docs and coverage
          git commit -m "chore: update Flutter documentation and test coverage [skip ci]"
          git push
